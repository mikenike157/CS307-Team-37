<!DOCTYPE html>
<html>
<head>
	<title>Poker Game</title>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.4.6/fabric.min.js"></script>
	<script type ="text/javascript" src="display.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<script>

	let dir = 'res/PNG/';

	$(document).ready(function(){
		let suits = ["hearts","clubs","spades","diamonds"];
		let faces = ["ace", "1", "2", "3", "4", '5', "6", "7", "8", "9", "10", "jack", "queen", "king"];

		let cName = "";
		for (var i = 0; i < 4; i++) {
			for(var j = 0; j < 13; j++) {

				cName = faces[j] + "_of_" + suits[i];
				//getImg(cName);
			}
		}


		drawRoom('pokerDisplay', $("#pokerDisplay").height(), $("#pokerDisplay").width());
		//Test block, remove later
		for(let i = 0; i < 8; i++){
			drawPlayerCards( true, false, ["ace_of_spades","queen_of_hearts"], i );
			if(i < 6 && i > 0){
				drawTableCard("ace_of_spades", i);
				if(i < 4){
					drawBlind('dealer', i );
				}
			}
		}
		/////////////////////////////



		drawPlayer("Jimbo", 500, 50, false, 0);
		drawPlayer("Michael", 500, 50, false, 0);
		drawPlayer("Jamison", 500, 50, true, 1);

		logObjects();

	});

	function getImg(name){

		$('body').append('<i src="'+ dir + name + '" id="'+ name +'">');

	}

	var idleCounter = 0;
	var timer;
	var pot = "Pot";
	var amountToCall = "Call Amount";
	var chips = "Total Chips";
	function updateScreen(newPot, newAmountToCall, newChips) {
		pot = newPot;
		amountToCall = newAmountToCall;
		chips = newChips;
		document.getElementById('fullPotTab').innerHTML=pot;
		document.getElementById('amountToCall').innerHTML=amountToCall;
		document.getElementById('chips').innerHTML=chips;
	}

	function boardHint(data) {
		for(let i = 0; i < data.length; i++) {
			if (data[i] == 0) {
				data[i] = "It is impossible.";
			}
			else if (data[i] == 1) {
				data[i] = "It is still possible";
			}
			else if (data[i] == 2) {
				data[i] = "You currently have";
			}
		}
		alert("High Card: " + data[0] + "\nPair: " + data[1] + "\nTwo Pair: " + data[2] + "\nThree of a kind: " + data[3] + "\nStraight: " + data[4] + "\nFLUSH: " + data[5] + "\nFull House: " + data[6] + "\nFour of a kind: " + data[7] + "\nStraight Flush: " + data[8]);
	}

	function handHint(data) {
		if (data == 1) {
			alert("Your hand isnt too great");
		}
		else if (data == 2) {
			alert("Your hand could be better");
		}
		else if (data == 3) {
			alert("Your hand is decent")
		}
		else if (data == 4) {
			alert("Your have a good hand");
		}
		else {
			alert("You have a great hand")
		}
	}

	function setTimer() {

	}

	function autoFold() {
		idleCounter++;
		clearTimeout(timer);
		socket.emit('playerFold')
		return;
	}

	var socket = io();
	//on connection to page load the username and call adduser on server side
	socket.on('connect', function() {
		$(function() {
			let name = "guest";
			let room = "null";
			$.ajax({
				async: false,
				type: 'GET',
				url: 'http://localhost/update_username',
				success: function(data) {
					name = data;
					console.log(name);
				}
			})
			$.ajax({
				async: false,
				type: 'GET',
				url: 'http://localhost/update_room',
				success: function(data) {
					room = data;
					console.log(room);
				}
			})
			socket.emit('adduser', name, room);
		})
	});
	
	socket.on('updateScreen', function(pot, amountToCall, chips) {
			updateScreen(pot, amountToCall, chips);
	});
	//on fold button press call the fold method on server side

	socket.on('updateTurn', function() {
		console.log("TIMER RESET. IDLECOUNTER: " + idleCounter);
		if (idleCounter == 0) {
			timer = setTimeout(autoFold, 15000)
			return;
		}
		else if (idleCounter < 5) {
			timer = setTimeout(autoFold, 5000);
			return;
		}
		else {
			document.getElementById('leaveButton').click();
		}
	})

	socket.on('boardHint', function(data) {
		boardHint(data);
	})
	socket.on('handHint', function(data) {
		handHint(data);
	})

	socket.on	('updatechat', function (username, data) {
		$('#chatDisplay').append(username + ':</b> ' + data + '<br>');
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
	});

	socket.on('dealCards', function(cards) {
		$('#chatDisplay').append("Cards: " + cards + '<br>');
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
	})

	socket.on('winner', function(data) {
		$('#chatDisplay').append("The winners of the hand are: " + data + '<br>');
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
	})

	socket.on('flop', function(data) {
		$('#chatDisplay').append("Flop: " + data.toString() + '<br>');
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
	})

	socket.on('turn', function(data) {
		$('#chatDisplay').append("Turn: " + data.toString() + '<br>');
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
	})

	socket.on('river', function(data) {
		$('#chatDisplay').append("River: " + data.toString() + '<br>');
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
	})

	$(function() {
		$('#raise').click( function() {
			idleCounter = 0;
			clearTimeout(timer);
			let betAmount = document.getElementById("customBet").value;
			socket.emit('playerRaise', betAmount);
		})
	})

	$(function() {
		$('#call').click( function() {
			idleCounter = 0;
			clearTimeout(timer);
			socket.emit('playerCall');
		})
	})

	$(function() {
		$('#fold').click( function() {
			clearTimeout(timer);
			idleCounter = 0;
			socket.emit('playerFold');
		})
	})
	$(function() {
		$('#hint').click( function() {
			socket.emit('playerHint');
		})
	})


	$(function(){
		// when the client clicks SEND
		$('#send').click( function() {
			var message = $('#text').val();
			$('#text').val('');
			// tell server to execute 'sendchat' and send along one parameter
			socket.emit('sendchat', message);
		});
		// when the client hits ENTER on their keyboard
		$('#text').keypress(function(e) {
			if(e.which == 13) {
				$(this).blur();
				$('#send').focus().click();
			}
		});
	});



</script>





<body>
	<input type="button" id="leaveButton" style="position:ablsoulte; top:0; right:0;" value="Leave Room" onclick="window.location.href = './main.html'">
	<canvas id="pokerDisplay">
	</canvas>
	<div id="gameBar">
		<div class="sub-container" id="chatBox">
			<div class="tab-select">

				<input class="logButtons" type="button" id="chatButton" value="Chat">

				<input class="logButtons" type="button" id="histButton" value="History">

				<input class="logButtons" type="button" id="hintLogButton" value="Hint Log">
			</div>
			<div id="chatDisplay" style="overflow-y:scroll">

			</div>
			<div id="chatInputField">
					<input type="text" id="text" name="chatMessage">
					<input type="submit" id="send" name="chatSubmit" value="Send">
			</div>
		</div>
		<div class="sub-container" id="hintBox">
			<input type="button" id="hint" name="hint" value="HINT">
		</div>
		<div class="sub-container" id="playerActions">
			<div class="tab-select">
				<div class="tab-head" id="amountToCall">
				Amount To Call
				</div>

				<div class="tab-head" id="fullPotTab">
				Pot
				</div>
				<div class="tab-head" id="chips">
					Total Chips
				</div>
				<div class="tab-head" id="customTab">
					<input class="bet" type="number" id="customBet" name="customBet" min="0">
				</div>
			</div>
			<div id="playerActionButtons">
				<input type="button" id="fold" name="Fold" value="Fold">
				<input type="button" id="call" name="Call" value="Call">
				<input type="button" id="raise" name="Raise" value="Raise">
			</div>
		</div>
	</div>
</body>
</html>
