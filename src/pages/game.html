
<!DOCTYPE html>
<html>
<head>
	<title>Poker Game</title>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.4.6/fabric.min.js"></script>
	<script type ="text/javascript" src="display.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<script>

	let dir = 'res/PNG/';

	$(document).ready(function(){


		drawRoom('pokerDisplay', $("#pokerDisplay").height(), $("#pokerDisplay").width());
		/*Test block, remove later
		for(let i = 0; i < 8; i++){
			drawPlayerCards( i % 2, false, ["ace_of_spades","queen_of_hearts"], i );
			if(i < 6 && i > 0){
				drawTableCard("ace_of_spades", i);
				if(i < 4){
					drawBlind('dealer', i );
				}
			}
			drawPlayer("Jamison", 500, 50, false, false,  i);
		}

		drawPlayerCards( false, true, ["ace_of_spades","queen_of_hearts"], i );
		////////////////////////////*/



		//drawPlayer("Jimbo", 500, 50, false, false, 0);
		//drawPlayer("Michael", 500, 50, false, true, 0);
		//drawPlayer("Jamison", 500, 50, true, true, 1);

		//logObjects();

	});

	var idleCounter = 0;
	var timer;
	var pot = "Pot";
	var amountToCall = "Call Amount";
	var chips = "Total Chips";

	function updateScreenAI(newPot, newAmountToCall, newChips) {
		pot = newPot;
		amountToCall = newAmountToCall;
		chips = newChips;
		setTimeout(function() {
			updateScreen(newPot, newAmountToCall, newChips);
		}, 5000);
	}

	function updateScreen(newPot, newAmountToCall, newChips) {
		pot = newPot;
		amountToCall = newAmountToCall;
		chips = newChips;
		document.getElementById('fullPotTab').innerHTML=pot;
		document.getElementById('amountToCall').innerHTML=amountToCall;
		document.getElementById('chips').innerHTML=chips;
	}

	function boardHint(data) {
		for(let i = 0; i < data.length; i++) {
			if (data[i] == 0) {
				data[i] = "It is impossible.";
			}
			else if (data[i] == 1) {
				data[i] = "It is still possible";
			}
			else if (data[i] == 2) {
				data[i] = "You currently have";
			}
		}
		alert("High Card: " + data[0] + "\nPair: " + data[1] + "\nTwo Pair: " + data[2] + "\nThree of a kind: " + data[3] + "\nStraight: " + data[4] + "\nFLUSH: " + data[5] + "\nFull House: " + data[6] + "\nFour of a kind: " + data[7] + "\nStraight Flush: " + data[8]);
	}

	function handHint(data) {
		if (data == 1) {
			alert("Your hand isnt too great");
		}
		else if (data == 2) {
			alert("Your hand could be better");
		}
		else if (data == 3) {
			alert("Your hand is decent")
		}
		else if (data == 4) {
			alert("Your have a good hand");
		}
		else {
			alert("You have a great hand")
		}
	}

	function setTimer() {

	}

	function autoFold() {
		idleCounter++;
		clearTimeout(timer);
		socket.emit('playerFold')
		return;
	}

	var socket = io();
	//on connection to page load the username and call adduser on server side
	socket.on('connect', function() {
		$(function() {
			let name = "guest";
			let room = "null";
			$.ajax({
				async: false,
				type: 'GET',
				//url: 'http://pokeruniversity.herokuapp.com/update_username',
				url: '/update_username',
				success: function(data) {
					name = data;
					console.log(name);
				}
			})
			$.ajax({
				async: false,
				type: 'GET',
				//url: 'http://pokeruniversity.herokuapp.com/update_room',
				url: '/update_room',
				success: function(data) {
					room = data;
					console.log(room);
				}
			})
			socket.emit('adduser', name, room);
		})
	});

	socket.on('updateScreen', function(pot, amountToCall, chips) {
			updateScreen(pot, amountToCall, chips);
	});
	//on fold button press call the fold method on server side
	socket.on('updateScreenAI', function(pot, amountToCall, chips) {
		updateScreenAI(pot, amountToCall, chips);
	})

	socket.on('updateTurn', function() {

		/*if (idleCounter == 0) {
			timer = setTimeout(autofold, 3000)
			idleCounter++;
		}
		else if (idleCounter != 5) {
			timer = setTimeout(autofold, 20000);
			idleCounter++;
		}
		else {
			document.getElementById('leave').click();
		}

		if (idleCounter == 0) {
			timer = setTimeout(autoFold, 15000)
			return;
		}
		else if (idleCounter < 5) {
			timer = setTimeout(autoFold, 5000);
			return;
		}
		else {
			document.getElementById('leave').click();
		} */



	})
	socket.on('handHint', function(data) {
		handHint(data);
	})
	socket.on('boardHint', function(data) {
		boardHint(data);
	})

	socket.on('updatePlayer', function(name, totalChips, betChips, folded, active, player){
		drawPlayer(name, totalChips, betChips, folded, active, player);
	});

	socket.on('updatePlayerCards', function(visible, folded, cards, pos){
		drawPlayerCards(visible, folded, cards, pos)
	})

	socket.on	('updatechat', function (username, data) {
		$('#chatDisplay').append(username + ':</b> ' + data + '<br>');
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
	});

	socket.on('renderBoardState', function(bigBlind, smallBlind, players){
		for (var i = 0; i < players.length; i++) {
			drawPlayer(players[i].username, players[i].chips, 0, false, false, i);
			drawBlind('big', bigBlind);
			drawBlind('small', smallBlind);
			drawPlayerCards( false, false, [], i );
		}
	});

	socket.on('dealCards', function(cards, pos) {
		//console.log("raw cards:" + cards);
		$('#chatDisplay').append("Cards: " + cards + '<br>');
		cards = cards.toString().split(',');
		drawPlayerCards( true, false, [processCard(cards[0]), processCard(cards[1])], pos );
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
	})

	socket.on('winner', function(data) {
		$('#chatDisplay').append("The winners of the hand are: " + data + '<br>');
		let obj = document.getElementById("chatDisplay");
		obj.scrollTop = obj.scrollHeight;
		clearTable();
	})

	socket.on('flop', function(data) {
		//console.log("flop cards:" + data);
		//setTimeout(function () {
			$('#chatDisplay').append("Flop: " + data.toString() + '<br>');
			let cards = data.toString().split(',');
			for (var i = 0; i < cards.length; i++) {
				let newCard = processCard(cards[i]);
				console.log("newCard" + newCard);
				drawTableCard(newCard, i );
			}
			let obj = document.getElementById("chatDisplay");
			obj.scrollTop = obj.scrollHeight;
	//	}, 6000);
	})

	socket.on('turn', function(data) {
		//console.log("turn cards:" + data
		//setTimeout(function() {
			$('#chatDisplay').append("Turn: " + data.toString() + '<br>');
			drawTableCard( processCard(data.toString()), 4 );
			let obj = document.getElementById("chatDisplay");
			obj.scrollTop = obj.scrollHeight;
		//}, 6000)
	})

	socket.on('river', function(data) {
		//console.log("river cards:" + data);
		//setTimeout(function() {
			$('#chatDisplay').append("River: " + data.toString() + '<br>');
			drawTableCard( processCard(data.toString()), 5 );
			let obj = document.getElementById("chatDisplay");
			obj.scrollTop = obj.scrollHeight;
	//	}, 6000);
	})

	$(function() {
		$('#raise').click( function() {
			idleCounter = 0;
			clearTimeout(timer);
			let betAmount = document.getElementById("customBet").value;
			socket.emit('playerRaise', betAmount);
		})
	})

	$(function() {
		$('#call').click( function() {
			idleCounter = 0;
			clearTimeout(timer);
			socket.emit('playerCall');
		})
	})

	$(function() {
		$('#fold').click( function() {
			clearTimeout(timer);
			idleCounter = 0;
			socket.emit('playerFold');
		})
	})
	$(function() {
		$('#hint').click( function() {
			socket.emit('playerHint');
		})
	})


	$(function(){
		// when the client clicks SEND
		$('#send').click( function() {
			var message = $('#text').val();
			$('#text').val('');
			// tell server to execute 'sendchat' and send along one parameter
			socket.emit('sendchat', message);
		});
		// when the client hits ENTER on their keyboard
		$('#text').keypress(function(e) {
			if(e.which == 13) {
				$(this).blur();
				$('#send').focus().click();
			}
		});
	});

	function processCard(card){
		//if(card.length <= 2){
			card = card.replace('D','_of_diamonds');
			card = card.replace('H','_of_hearts');
			card = card.replace('S','_of_spades');
			card = card.replace('C','_of_clubs');
			card = card.replace("A", 'ace');
			card = card.replace("Q", 'queen');
			card = card.replace("J", 'jack');
			card = card.replace("K", 'king')
		//}
		//console.log("card:" +  card);
		return card;
	}
</script>

<body>
	<input type="button" id="leaveButton" style="position:ablsoulte; top:0; right:0;" value="Leave Room" onclick="window.location.href = './main.html'">
	<canvas id="pokerDisplay">
	</canvas>
	<div id="gameBar">
		<div class="sub-container" id="chatBox">
			<div class="tab-select">

				<input class="logButtons" type="button" id="chatButton" value="Chat">

				<input class="logButtons" type="button" id="histButton" value="History">

				<input class="logButtons" type="button" id="hintLogButton" value="Hint Log">
			</div>
			<div id="chatDisplay" style="overflow-y:scroll">

			</div>
			<div id="chatInputField">
					<input type="text" id="text" name="chatMessage">
					<input type="submit" id="send" name="chatSubmit" value="Send">
			</div>
		</div>
		<div class="sub-container" id="hintBox">
			<input type="button" id="hint" name="hint" value="HINT">
		</div>
		<div class="sub-container" id="playerActions">
			<div class="tab-select">
				<div class="tab-head" id="amountToCall">
				Amount To Call
				</div>

				<div class="tab-head" id="fullPotTab">
				Pot
				</div>
				<div class="tab-head" id="chips">
					Total Chips
				</div>
				<div class="tab-head" id="customTab">
					<input class="bet" type="number" id="customBet" name="customBet" min="0">
				</div>
			</div>
			<div id="playerActionButtons">
				<input type="button" id="fold" name="Fold" value="Fold">
				<input type="button" id="call" name="Call" value="Call">
				<input type="button" id="raise" name="Raise" value="Raise">
			</div>
		</div>
	</div>
</body>
</html>
